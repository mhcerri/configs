#!/bin/bash -eu

#
# Configuration
#
ROFI=rofi-run

# Helpers to store the options
options=()
add_option() {
	# add_option <IN|OUT> <index> <name> <desc>
	# Exclude monitors
	[[ -z "$2" ]] && return
	[[ "$4" = *Monitor* ]] && return
	options+=( "$(printf '%3s: %02d: %s' "${1}" "${2}" "${4:-$3}")" )
}

get_tag() {
	case "$1" in
	OUT) echo 'Sink';;
	IN)  echo 'Source';;
	esac
}

get_type() {
	get_tag "$@" | tr '[:upper:]' '[:lower:]'
}

# List sources and sinks
for dir in OUT IN; do
	#
	# Retrieve list from pulseaudio
	#
	index=
	name=
	desc=
	tag=$(get_tag "$dir")
	type=$(get_type "$dir")
	while read -r line; do
		case "$line" in
		"${tag} #"*)
			add_option "$dir" "$index" "$name" "$desc"
			index="${line#*#}"
			name=
			desc=
			;;
		Name:*)
			name="${line#*:}"
			name="${name# }"
			;;
		Description:*)
			desc="${line#*:}"
			desc="${desc# }"
			;;
		esac
	done < <(LC_ALL=C pactl list "${type}s")
	add_option "$dir" "$index" "$name" "$desc"
done

# Ask user
choice=$(for opt in "${options[@]}"; do
		 echo "$opt"
	 done | "$ROFI" -dmenu -i)

# Parse choice
dir=$(echo "$choice" | cut -d: -f1 | sed -r 's/(^\s*|\s*$)//g')
index=$(echo "$choice" | cut -d: -f2 | sed -r 's/(^\s*0*|\s*$)//g')
name=$(echo "$choice" | cut -d: -f3 | sed -r 's/(^\s*|\s*$)//g')
type=$(get_type "$dir")

# Chance device
pactl "set-default-${type}" "$index"

# Notify
notify-send -u low "$dir: $name"
