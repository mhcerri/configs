#!/bin/bash -eu

#
# Configuration
#
ROFI=rofi-run

#
# Parse options
#
option="${1:-}"
if [ -z "$option" ]; then
	option=$( (echo output; echo input) | "$ROFI" -dmenu)
fi
case "$option" in
output)
	type='sink'
	tag='Sink'
	;;
input)
	type='source'
	tag='Source'
	;;
*)
	echo "Invalid option: $option"
	exit 1
esac

#
# Helper to store the options
#
#declare -A options
options=()
add_option() {
	[ -z "$index" ] && return
	# Exclude monitors
	[[ "$3" = *Monitor* ]] && return
	options+=( "${1}: ${3:-$2}" )
}

#
# Retrieve list from pulseaudio
#
index=
name=
desc=
while read -r line; do
	case "$line" in
	"${tag} #"*)
		add_option "$index" "$name" "$desc"
		index="${line#*#}"
		name=
		desc=
		;;
	Name:*)
		name="${line#*:}"
		name="${name# }"
		;;
	Description:*)
		desc="${line#*:}"
		desc="${desc# }"
		;;
	esac
done < <(LC_ALL=C pactl list "${type}s")
add_option "$index" "$name" "$desc"

#
# Ask user
#
choice=$(for opt in "${options[@]}"; do
		 echo "$opt"
	 done |
	 "$ROFI" -dmenu)

# Chance device
index="${choice%%:*}"
pactl "set-default-${type}" "$index"

# Notify
name="${choice#*: }"
notify-send -u low "$name"
